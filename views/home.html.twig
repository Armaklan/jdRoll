{% extends "squelette.html.twig" %}

{% block content %}
	
	<h3>Bienvenue sur la plateforme jdRoll ! </h3>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span7">
				
				<p></p>
				<p>Envie de rejoindre une partie ? Regardez les campagnes qui recrute dans <b>Jouer > Rejoindre une campagne</b></p>
				<p>Envie de proposer une partie ? Allez sur <b>Jouer > Créer une campagne.</b></p>
				<p></p>
				<p>Jouer sur les parties où vous vous êtes inscrit ? Simple, cliquez sur le nom de la partie dans votre sidebar,
				 vous débrancherez alors dans l'espace spécifique à votre campagne.</p>
				<p></p>
				<p>Envie de discuter avec les autres joueurs de la communauté ? Utiliser le <b>forum</b> ou le <b>tchat</b> dans le menu <b>"Discuter"</b>.</p>
				
			</div>
			<div class="span5">
				<h5>Derniers inscrits :</h5>
				<p>
				{% set isFirst = true %}
				{% for user in last_users %}
					{% if not isFirst %}
						,
					{% endif %}
					<a href="{{ path('profile',{username: user.username} ) }}">{{ user.username }}</a>
					{% set isFirst = false %}
				{% endfor %}
				</p>
				<h5>Dernières campagnes ajoutées :</h5>
				<p>
				{% set isFirst = true %}
				{% for campagne in campagnes %}
					{% if not isFirst %}
						<br>
					{% endif %}
					<a href="{{ path('campagne',{id: campagne.id} ) }}">{{ campagne.name }} ({{ campagne.univers }})</a>
					{% set isFirst = false %}
				{% endfor %}
				</p>
				<h5>Actuellement en ligne :</h5>
				<p>
				{% set isFirst = true %}
				{% for user in connected_users %}
					{% if not isFirst %}
						,
					{% endif %}
					<a href="{{ path('profile',{username: user.username} ) }}" {% if user.profil > 0 %} style="color: red" {% endif %}>{{ user.username }}</a>
					{% set isFirst = false %}
				{% endfor %}
				</p>
			</div>
		</div>

		<div class="row-fluid" style="margin-top: 1em;">
			<div class="span10 offset1 chatbox">
				<h5 class="categorie">Chat</h5>
		        <div id="text" style="height: 250px; overflow: auto;">
		            <div id="loading">
		                <center>
		                <span class="info" id="info">Chargement du chat en cours...</span><br />
		                <img src="{{app.request.baseUrl}}/img/ajax-loader.gif" alt="patientez...">
		                </center>
		            </div>
		        </div>
		        
		        <div style="text-align: center; margin-top: 1em;">
		        	{% if (app.session.get('user') != null)  %}
			        <form class="form-inline" onsubmit="postMessage(); return false;">
				        <div class="input-append">
						  <input class="input-xxlarge" id="messageChat" type="text">
						  <input type="submit" class="btn">Envoyer</button>
						</div>
						
					</form>
					
					<script>
					function postMessage() {
						textMsg=$('#messageChat').val();
						$('#messageChat').val('');
						user="{{ app.session.get('user')['login'] }}";
						$.ajax({
						    type: "POST",
						    url: "{{ path('chat_post') }}",
						    data: {message: textMsg, user: user},
						    success: function(msg){
						    	
						    },
						    error: function(msg) {
						    	$('#messageChat').val(textMsg);
							}
						});
					}
					</script>
					{% else %}
		        		Il est nécessaire d'être authentifier pour poster un message		        		
		        	{% endif %}

		        </div>
		        
		        
			</div>
		</div>
		<script>

		var reloadTime = 1000;
		var scrollBar = false;

		function getMessages() {
			$.ajax({
			    type: "GET",
			    url: "{{ path('chat_last_msg') }}",
			    success: function(msg){

			    	 	var container = $('#text');
		                var content = $('#messageContent');
		                var height = content.height()-250;
		                var toBottom;
		 
		                if(container[0].scrollTop == height)
		                    toBottom = true;
		                else
		                    toBottom = false;

		                $("#text").html(msg);
		 
		                content = $('#messages_content');
		                height = content.height()-250;
		                 
		                if(toBottom == true)
		                	container[0].scrollTop = container[0].scrollHeight

		                if(scrollBar != true) {
		                	container.animate({scrollTop: container[0].scrollHeight},3000);
		                    scrollBar = true;
		                }   

			    },
			    error: function(msg) {
			    	
				}
			});
		}

	

		$(document).ready(function() {
			 window.setInterval(getMessages, reloadTime);
		});
			
		</script>
		
	</div>  
		

{% endblock %}