var ngApplication=angular.module("jdroll",["ngRoute","ngDragDrop","leaflet-directive","ajoslin.promise-tracker","mgcrea.ngStrap"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/carte/create",{templateUrl:"js/angular/carte/index-creator.html",controller:"CtrlCarteCreator"}).when("/carte/:carteId",{templateUrl:"js/angular/carte/index-manager.html",controller:"CtrlCarteManager",resolve:{carte:function($route,$http,$q,$rootScope){var deferred=$q.defer();return $http.get("carte/"+$route.current.params.carteId).then(function(response){var carte=response.data,request=$rootScope.getImageDimension(carte.image).then(function(dimensions){carte.dimensions=dimensions,deferred.resolve(carte)});$rootScope.loadingTracker.addPromise(request)}),deferred.promise}}})}]).run(function($rootScope,$q,promiseTracker){$rootScope.getImageDimension=function(url){var deferred=$q.defer();return $("<img/>").attr("src",url).load(function(){deferred.resolve({w:this.width,h:this.height})}),deferred.promise},$rootScope.loadingTracker=promiseTracker(),$rootScope.getCampagneId=function(){return parseInt(window.location.pathname.split("/").slice(-2)[0])}});ngApplication.controller("CtrlCarteCreator",["$scope","$http","$location",function($scope,$http,$location){$scope.carte={campagne_id:$scope.getCampagneId(),published:"1"},$scope.messages=[],$scope.create=function(){if($scope.messages=[],$scope.carte.name||$scope.messages.push("Le nom est obligatoire."),$scope.carte.image||$scope.messages.push("L'image est obligatoire."),!$scope.messages.length){var request=$http.post("carte/save",$scope.carte).success(function(carte){$location.path("/carte/"+carte.id)});$scope.loadingTracker.addPromise(request)}}}]),ngApplication.controller("CtrlCarteManager",["$scope","$http","$timeout","leafletData","leafletLayerHelpers","leafletBoundsHelpers","leafletMarkersHelpers","carte",function($scope,$http,$timeout,leafletData,leafletLayerHelpers,leafletBoundsHelpers,leafletMarkersHelpers,carte){$scope.carte=angular.copy(carte),$scope.options={defaults:{minZoom:-4,maxZoom:4,crs:L.CRS.Simple,attributionControl:!1,zoomControl:!1},center:[0,0],markers:{},layers:{baselayers:{}},controls:{custom:[]}},$scope.dropOptions={onDrop:"onDropItem"},$scope.interface={image:$scope.carte.image,tab:"perso"};var onGetMap=function(map){$scope.map=map,imageSetup()},imageSetup=function(){var bounds=[[-$scope.carte.dimensions.h/2,-$scope.carte.dimensions.w/2],[$scope.carte.dimensions.h/2,$scope.carte.dimensions.w/2]],offsetBounds=Math.max($scope.carte.dimensions.h,$scope.carte.dimensions.w);$scope.map.options.minZoom=-4,$scope.map.options.maxZoom=4,$scope.map.setMaxBounds([[-carte.dimensions.h/2-offsetBounds,-carte.dimensions.w/2-offsetBounds],[carte.dimensions.h/2+offsetBounds,carte.dimensions.w/2+offsetBounds]]),$scope.map.eachLayer(function(layer){layer._image&&$scope.map.removeLayer(layer)});var layer=leafletLayerHelpers.createLayer({name:"map",type:"imageOverlay",url:$scope.carte.image,bounds:bounds});return $scope.map.addLayer(layer),$timeout(function(){$scope.map.fitBounds(bounds),$scope.map.once("zoomend",function(){$scope.map.options.minZoom=$scope.map.getZoom(),$scope.map.options.maxZoom=$scope.map.getZoom()+4})}),layer},createMarker=function(id,type,position,image,title,cls,popup){var uniqueId=type+id,marker={lat:position[0],lng:position[1],title:title,type:type,icon:{type:"div",iconSize:[48,48],iconAnchor:[24,24],popupAnchor:[0,0],html:_.isEmpty(image)?"":'<img src="'+image+'"/>',className:"map-pin map-pin-"+type+" "+cls},draggable:$scope.carte.isMj?!0:!1},scope=$scope.$new(),popupFile="popup-"+($scope.carte.isMj===!0?"mj":"player")+"-"+type+".html";return scope.popup=popup&&!_.isArray(popup)?popup:{},scope.marker=marker,marker.popup=scope.popup,marker.getMessageScope=function(){return scope},marker.message='<div class="map-popup map-popup-'+type+'" ng-include src="\'js/angular/carte/'+popupFile+"'\"></div>",$scope.options.markers[uniqueId]=marker,{marker:marker,scope:scope}},createMarkerPerso=function(perso,position,popup){var created=createMarker(perso.id,"perso",position,"files/thumbnails/perso_"+perso.id+".png",perso.name,perso.user_id?"map-pin-perso-user":"",popup);created.marker.id=perso.id,created.marker.perso=perso,perso.onMap=!0},removeMarker=function(marker){"perso"==marker.type&&(marker.perso.onMap=!1),delete $scope.options.markers[marker.type+marker.id]},createMarkerCustom=function(id,position,popup){var id=id?id:Math.max(_.max(_.pluck(_.where($scope.options.markers,{type:"custom"}),"id")),0)+1,created=createMarker(id,"custom",position,popup.image,"Marqueur Personnalisé","",popup);created.marker.id=id,created.scope.id=id,$scope.$watch(function(){return created.scope.popup.image},function(){created.marker.icon.html='<img src="'+created.scope.popup.image+'"/>'},!0)},updateCarteMarkers=function(){var markers=[];_.each($scope.options.markers,function(marker){markers.push({type:marker.type,id:marker.id,position:[marker.lat,marker.lng],popup:marker.popup})}),_.isEqual($scope.carte.config.markers,markers)||($scope.carte.config.markers=markers)},saveMap=_.debounce(function(){var copy=angular.copy($scope.carte);delete copy.personnages,copy.image==carte.image?delete copy.image:carte.image=$scope.carte.image;var request=$http.post("carte/save",copy);$scope.loadingTracker.addPromise(request)},500),onMarkersChange=function(newValue,oldValue){_.isEqual(newValue,oldValue)||updateCarteMarkers()},onCarteChange=function(){saveMap()},onImageChange=function(newImage,oldImage){newImage!=oldImage&&$scope.getImageDimension(newImage).then(function(dimensions){if(dimensions.w&&dimensions.h){$scope.carte.dimensions=dimensions,$scope.carte.image=newImage;var layer=imageSetup(),bounds=layer._bounds,corner=bounds.getNorthEast();_.each($scope.options.markers,function(marker){bounds.contains([marker.lat,marker.lng])||(marker.lat=corner.lat,marker.lng=corner.lng)})}})};$scope.onDropItem=function(event,ui){var imageOffset=ui.draggable.width()/2,mapOffset=$($scope.map.getContainer()).offset(),scope=ui.draggable.scope(),p=$scope.map.containerPointToLatLng([ui.offset.left-mapOffset.left+imageOffset,ui.offset.top-mapOffset.top+imageOffset]);scope.perso?createMarkerPerso(scope.perso,[p.lat,p.lng]):createMarkerCustom(null,[p.lat,p.lng],{image:"img/defaultCustom.png"}),$scope.onDragEnd()},$scope.onDrag=function(){jQuery(".tooltip").hide(),jQuery(".map-sidebar").css("background-color","rgba(255,255,255, 0.2)")},$scope.onDragEnd=function(){jQuery(".map-sidebar").css("background-color","#fff")},$scope.removeMarker=function(marker){confirm("Êtes vous sûr(e) de vouloir retirer ce marqueur de la carte?")&&removeMarker(marker)},$scope.selectTab=function(tab){$scope.interface.tab=tab,$scope.carte.config.tabReduce=!1},$scope.carte.config.markers&&$scope.carte.config.markers.forEach(function(marker){"perso"==marker.type?createMarkerPerso(_.findWhere($scope.carte.personnages,{id:marker.id}),marker.position,marker.popup):"custom"==marker.type&&createMarkerCustom(marker.id,marker.position,marker.popup)}),leafletData.getMap().then(onGetMap),$scope.carte.isMj===!0&&($scope.$watch(function(){return $scope.options.markers},onMarkersChange,!0),$scope.$watch(function(){return $scope.carte},onCarteChange,!0),$scope.$watch(function(){return $scope.interface.image},onImageChange,!0))}]);