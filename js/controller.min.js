function filterTable(idFilter,idTable){var searchText=$(idFilter).val().toLowerCase();$(idTable+" tr ").each(function(){currentSearchIndex=$(this).find(".filterIndex").val().toLowerCase(),"header"!=currentSearchIndex&&(currentSearchIndex.indexOf(searchText)>-1?($(this).css("display",""),$(this).removeClass("hide")):($(this).css("display","none"),$(this).addClass("hiding")))})}function filterList(idFilter,idTable){var searchText=$(idFilter).val().toLowerCase();$(idTable+" > div ").each(function(){currentSearchIndex=$(this).find(".filterIndex").val().toLowerCase(),"header"!=currentSearchIndex&&(currentSearchIndex.indexOf(searchText)>-1?($(this).css("display",""),$(this).removeClass("hide")):($(this).css("display","none"),$(this).addClass("hiding")))})}function onBtnDangerClick(form){bootbox.confirm("L'action demandé est une action dangereuse (Suppression, Quitter une partie, ...). Etes-vous sur ? ",function(confirmed){confirmed&&$(form).submit()})}function selectAll(formName){var checked=$(formName).find(".checkAll").is(":checked");$(formName).find("tr:not(.hiding)").find("input[type=checkbox]").prop("checked",checked)}function alarm(joueur,campagne){var statutAlarm=0,alarm=$(".alarm-pj");alarm.hasClass("alarm-on")?(alarm.removeClass("alarm-on"),statutAlarm=0):(alarm.addClass("alarm-on"),statutAlarm=1),$.ajax({type:"POST",url:"/campagne/alarm",data:{joueur:joueur,campagne:campagne,statut:statutAlarm},success:function(){},error:function(){}})}var selected=[],formats=[{title:"Dialogue",inline:"span",classes:"dialogue"},{title:"Pensée",inline:"span",classes:"pensee"},{title:"RP1",inline:"span",classes:"rp1"},{title:"RP2",inline:"span",classes:"rp2"},{title:"Hrp",inline:"span",classes:"hrp"},{title:"Titre 1",block:"h1"},{title:"Titre 2",block:"h2"},{title:"Titre 3",block:"h3"},{title:"Citation",block:"blockquote"}],configBase={plugins:["link image lists hr","table textcolor fullscreen","emoticons code"],content_css:BASE_PATH+"/css/main.css",browser_spellcheck:!0,convert_urls:!1,toolbar:"cut copy paste | styleselect removeformat | bold italic forecolor | alignleft aligncenter alignright alignjustify | hr | bullist numlist outdent indent | link image | fullscreen | emoticons private hide popup perso perso2",style_formats:formats,autosave_ask_before_unload:!1,setup:function(editor){editor.addButton("private",{text:"Prv",icon:!1,onclick:function(){editor.windowManager.open({title:"Message privé",url:BASE_PATH+"/editor/tagPrivate/"+CAMPAGNE_ID,height:"280",buttons:[{text:"OK",classes:"widget btn primary first abs-layout-item",disabled:!1,onclick:function(){{var find_src=BASE_PATH+"/editor/tagPrivate/"+CAMPAGNE_ID,items=[];$("iframe[src='"+find_src+"']").contents().find("select option:selected").each(function(){items.push($(this).val())})}editor.execCommand("mceInsertContent",0,"[private="+items.join(",")+"]"+editor.selection.getContent()+"[/private]"),editor.windowManager.close()}},{text:"Cancel",onclick:"close"}]})}}),editor.addButton("hide",{text:"Hid",icon:!1,onclick:function(){var content=tinyMCE.activeEditor.selection.getContent();editor.insertContent("[hide]"+content+"[/hide]")}}),editor.addButton("popup",{text:"Pop",icon:!1,onclick:function(){editor.windowManager.open({title:"Informations Popup",body:[{type:"textbox",name:"title",label:"Titre :"},{type:"textbox",name:"link",label:"Lien affiché :"}],onsubmit:function(e){var content=tinyMCE.activeEditor.selection.getContent();editor.insertContent("[popup="+e.data.title+","+e.data.link+"]"+content+"[/popup]")}})}}),editor.addButton("perso",{text:"PNJ",icon:!1,onclick:function(){editor.windowManager.open({title:"Lien vers fiche PNJ",url:BASE_PATH+"/editor/tagPerso/"+CAMPAGNE_ID,height:"280",buttons:[{text:"OK",classes:"widget btn primary first abs-layout-item",disabled:!1,onclick:function(){var find_src=BASE_PATH+"/editor/tagPerso/"+CAMPAGNE_ID,val=$("iframe[src='"+find_src+"']").contents().find("select option:selected").val(),content=editor.selection.getContent()?editor.selection.getContent():val;editor.execCommand("mceInsertContent",0,"[pnj="+val+"]"+content+"[/pnj]"),editor.windowManager.close()}},{text:"Cancel",onclick:"close"}]})}})}},configPost=jQuery.extend(!0,{},configBase);configPost.min_height=160,configPost.selector=".wysiwyg";var configMobile=jQuery.extend(!0,{},configBase);configMobile.plugins=["link image lists hr","table textcolor fullscreen","emoticons code"],configMobile.toolbar="paste | styleselect removeformat | bold italic | hr | link image | code",configMobile.menubar=!1,configMobile.min_height=400,configMobile.selector=".wysiwyg";var configNote=jQuery.extend(!0,{},configBase);configNote.toolbar="cut copy paste | styleselect removeformat | bold italic forecolor | alignleft aligncenter alignright alignjustify | hr | bullist numlist outdent indent | link image | fullscreen | emoticons",configNote.min_height=160,configNote.selector=".note-wysiwyg";var configNoteMobile=jQuery.extend(!0,{},configNote);configNoteMobile.min_height=160,configNoteMobile.width=300,configNoteMobile.selector=".note-wysiwyg",-1!=navigator.userAgent.indexOf("IE")?(tinymce.init(configPost),tinymce.init(configNote)):window.matchMedia("(min-width: 600px)").matches?(tinymce.init(configPost),tinymce.init(configNote)):(tinymce.init(configMobile),tinymce.init(configNoteMobile));var onLoadControllerImpl=function(){function executeAllMethods(methods){methods.forEach(function(method){method()})}var generals=[],campagnes=[],withChats=[];return{generals:generals,campagnes:campagnes,withChats:withChats,onLoadGenerals:function(){executeAllMethods(generals)},onLoadChat:function(){executeAllMethods(withChats)},onLoadCampagnes:function(){executeAllMethods(campagnes)}}},onLoadController=onLoadControllerImpl(),campagneControllerImpl=function(){function updateAdminOpen(state){0!==CAMPAGNE_ID&&$.ajax({type:"POST",url:BASE_PATH+"/campagne/admin_open",data:{id:CAMPAGNE_ID,state:state},success:function(){},error:function(){}})}function favorised(campagne,statut){$.ajax({type:"POST",url:BASE_PATH+"/campagne/favoris",data:{campagne:campagne,statut:statut},success:function(){},error:function(){}})}return{onAdminOpenChanged:function(){$("#admMode").click(function(){$("#admMode").hasClass("admDisabled")?($("#admMode").removeClass("admDisabled"),$(".admIcone").removeClass("invisible"),$("#admMode i").removeClass("icon-eye-open"),$("#admMode i").addClass("icon-eye-close"),updateAdminOpen(1)):($("#admMode").addClass("admDisabled"),$(".admIcone").addClass("invisible"),$("#admMode i").removeClass("icon-eye-close"),$("#admMode i").addClass("icon-eye-open"),updateAdminOpen(0))})},onFavorised:function(){$("#favorised").click(function(){var campagneId=$(this).attr("data-campagne-id");$("#favorised").hasClass("notFavorised")?($("#favorised").removeClass("notFavorised"),$("#favorised i").removeClass("icon-star-empty"),$("#favorised i").addClass("icon-star"),favorised(campagneId,1)):($("#favorised").addClass("notFavorised"),$("#favorised i").removeClass("icon-star"),$("#favorised i").addClass("icon-star-empty"),favorised(campagneId,0))})}}},campagneController=campagneControllerImpl();onLoadController.campagnes.push(campagneController.onAdminOpenChanged),onLoadController.campagnes.push(campagneController.onFavorised);var chatControllerImpl=function(){function isAutoScrollOn(content){return container[0].scrollTop==content.height()-msgDivHeight}function initialLoad(){var before=lastMsgs.substring(0,lastMsgs.lastIndexOf("</tr>")),after=lastMsgs.substring(lastMsgs.lastIndexOf("</tr>")+5),msgs=before+"</tr>"+lastMsg+after;lastMsgs=msgs,$("#text").html(msgs)}function appendMsg(){$("#tableChat tr:last").after(lastMsg)}function deleteMsg(deleted){deleted.forEach(function(rowId){$("#chat_tr_"+rowId.messageId).remove()})}function scrollToBottom(isAutoScroll){$("#messages_content").height()-msgDivHeight;isAutoScroll===!0&&(container[0].scrollTop=container[0].scrollHeight)}function addScrollbar(){1!=scrollBar&&(container[0].scrollTop=container[0].scrollHeight,scrollBar=!0)}function getMessages(){$.ajax({type:"GET",url:BASE_PATH+"/chat/last",timeout:5e3,data:{isFirst:isFirstLoad,lastId:lastMsgId}}).done(function(msg){if($("#text").html()!=msg){var content=($("#text"),$("#messageContent")),isAutoScroll=isAutoScrollOn(content);lastMsgId=msg.last_id.trim(),lastMsg=msg.last_msg,isFirstLoad?initialLoad():appendMsg(),deleteMsg(msg.deleted),scrollToBottom(isAutoScroll),addScrollbar(),isFirstLoad=!1}}).always(function(){setTimeout(getMessages,reloadTime)})}function activateChat(){container=$("#text"),msgDivHeight=$("#text").height(),getMessages()}function keyEvent(){$("#messageChat").on("keyup",function(){"@"==$("#messageChat").val()&&($("#chatTo").select2("open"),$("#messageChat").val(""))})}function getOnline(){$.ajax({type:"GET",url:BASE_PATH+"/chat/users",success:function(msg){$("#onlineUsers").html(msg)},error:function(){}})}var container,scrollBar=!1,isFirstLoad=!0,reloadTime=1500,lastMsgs="",lastMsgId=0,msgDivHeight=300;return{postMessage:function(user){textMsg=$("#messageChat").val(),$("#messageChat").val(""),to=$("#chatTo").val(),$.ajax({type:"POST",url:BASE_PATH+"/chat/post",data:{message:textMsg,user:user,to:to},success:function(){},error:function(){$("#messageChat").val(textMsg)}})},postMessageMobile:function(user){textMsg=$("#messageChatMobile").val(),$("#messageChatMobile").val(""),to="",$.ajax({type:"POST",url:BASE_PATH+"/chat/post",data:{message:textMsg,user:user,to:to},success:function(){},error:function(){$("#messageChatMobile").val(textMsg)}})},deleteLastMessages:function(){$.ajax({type:"POST",url:BASE_PATH+"/chat/removelast",data:{nbToDelete:30},success:function(){},error:function(){}})},initMessage:function(){activateChat(),keyEvent()},initOnline:function(){getOnline(),window.setInterval(getOnline,3e4)}}},chatController=chatControllerImpl();onLoadController.withChats.push(chatController.initMessage),onLoadController.withChats.push(chatController.initOnline);var draftControllerImpl=function(){function getNowHour(){var nowDate=new Date;return nowDate.getHours()+":"+nowDate.getMinutes()+":"+nowDate.getSeconds()}function refreshSaveTime(){$("#enregResult").html("Enregistré à "+getNowHour()+' <i class="icon-save"></i>')}function ajaxPost(){$("#waitingPost").removeClass("hide"),$("#btn-reply").attr("disabled","disabled");var persoId,id=$("input[name=id]").val(),topicId=$("input[name=topic_id]").val();persoId=$("input[name=perso_id]").length?$("input[name=perso_id]").val():$("select[name=perso_id]").select2("val"),tinyMCE.triggerSave(),content=$("#content").val(),$.ajax({type:"POST",timeout:1e4,url:BASE_PATH+"/forum/"+CAMPAGNE_ID+"/post/save",data:{id:id,topic_id:topicId,perso_id:persoId,content:content}}).done(function(msg){window.location.assign(msg)}).fail(function(){$("#enregResult").html('<span class="alert alert-danger">Impossible de poster le message <i class="icon-save"></i></span>'),$("#btn-reply").removeAttr("disabled")}).always(function(){$("#waitingPost").addClass("hide")})}function preview(){tinyMCE.triggerSave();var content=$("#content").val();$.ajax({type:"POST",url:BASE_PATH+"/forum/"+CAMPAGNE_ID+"/preview",data:{content:content},success:function(msg){$("#previewCell").html(msg.content),$("tr#previewRow").removeClass("hide")},error:function(){}})}function ajaxEnreg(){topic_id=$("input[name=topic_id]").val();var perso_id;perso_id=$("input[name=perso_id]").length?$("input[name=perso_id]").val():$("select[name=perso_id]").select2("val"),tinyMCE.triggerSave(),content=$("#content").val(),$.ajax({type:"POST",url:BASE_PATH+"/forum/"+CAMPAGNE_ID+"/topic/draft",data:{topic_id:topic_id,perso_id:perso_id,content:content},success:function(){refreshSaveTime()},error:function(){}})}function autoSave(){var element=$("#btn-enreg");element.length&&window.setInterval(ajaxEnreg,6e4)}return{ajaxEnreg:ajaxEnreg,autoSave:autoSave,ajaxPost:ajaxPost,preview:preview}},draftController=draftControllerImpl();onLoadController.generals.push(draftController.autoSave);var notifControllerImpl=function(){function refreshNotif(){$.ajax({type:"GET",url:BASE_PATH+"/notification/ajax",success:function(msg){$("#notificationCenter").html(msg.content),$("#notifNumber").html(msg.nb_notif),msg.nb_notif>0?($("#notifIndicator").addClass("btn-notifs"),$("#notifIndicator").removeClass("btn-default")):($("#notifIndicator").removeClass("btn-notifs"),$("#notifIndicator").addClass("btn-default")),updateFavicon()},error:function(){}})}var favicon=new Favico({type:"rectangle",animation:"slide"}),decrementeNbMsg=function(){var notifZone=$("#notifNumber"),nbMsg=notifZone.text().trim();nbMsg-=1,notifZone.text(nbMsg),0==nbMsg&&setToNoMsg(),updateFavicon()},setToNoMsg=function(){$("#notifNumber").text("0"),$("#notifIndicator").removeClass("btn-notifs"),$("#notifIndicator").addClass("btn-default"),$("#msg-zone").text("")},ajaxDeleteNotif=function(idNotif){$.ajax({type:"POST",url:BASE_PATH+"/notification/del",data:{id:idNotif},success:function(){},error:function(){}})},updateFavicon=function(){var number=parseInt($("#notifNumber").html());number?favicon.badge(number):favicon.reset()};return updateFavicon(),{deleteNotif:function(idNotif){ajaxDeleteNotif(idNotif),decrementeNbMsg()},clearNotif:function(){$(".notifMsg").each(function(){var idNotif=$(this).attr("id").replace("notif","");ajaxDeleteNotif(idNotif)}),setToNoMsg()},toggleNotif:function(){$("#notif").hasClass("notifHide")?$("#notif").removeClass("notifHide"):$("#notif").addClass("notifHide")},onClickHorsDiv:function(){var oDiv=$("#notif");$(document.body).click(function(e){if(!oDiv.hasClass("notifHide")){var evt=window.event||arguments[0],src=evt.target||evt.srcElement;if(-1==src.id.indexOf("notif")&&0==$(src).parents("#notificationCenter").length){var oElem=e?e.target:event.srcElement;oElem!==oDiv&&oDiv.addClass("notifHide")}}})},ajaxRefresh:function(){window.setInterval(refreshNotif,12e4)}}},notifController=notifControllerImpl();onLoadController.generals.push(notifController.ajaxRefresh),onLoadController.generals.push(notifController.onClickHorsDiv);var uiControllerImpl=function(){function activateSelect2(){$(".select2").select2({width:"resolve"}),$(document).on("keydown",function(e){keyIsDown=e.ctrlKey}),$(document).on("keyup",function(e){keyIsDown=e.ctrlKey}),$(document).on("keypress",function(e){keyIsDown=e.ctrlKey}),$(".navigationSelect").on("select2-selecting",function(val){changeLocation(val.val,keyIsDown)})}function activateAffix(){$(".affix").affix({offset:{top:200},bottom:function(){return this.bottom=$(".footer").outerHeight(!0)}})}function activateColorpicker(){$(".colorpicker").colorpicker()}function activateTooltip(){$(".iconeBtn").tooltip({container:"body"}),$(".popover-elt").popover()}function autofocus(){$(".focus-elt").focus()}function resizeSidebar(){$(window).width()>992?($(".maxheight").css({height:$(window).height()-50+"px"}),$(".maxheight").css({overflow:"auto"})):($(".maxheight").css({height:"100%"}),$(".maxheight").css({overflow:"visible"}))}function activateSidebarLayout(){resizeSidebar(),$(window).resize(function(){resizeSidebar()})}function activateZeroClipboard(){ZeroClipboard.config({moviePath:BASE_PATH+"/vendor/zeroclipboard/ZeroClipboard.swf"}),client=new ZeroClipboard($("#btn-upload-copy"))}function associateCopyBtn(){client.on("load",function(){}),client.on("complete",function(){alert("Url copié dans le presse papier ")})}function activateCarousel(){$(".carousel-control.right").trigger("click")}var client,keyIsDown=!1,changeLocation=function(url,ctrlKey){""!=url&&(ctrlKey?window.open(url):window.location=url)};return{activateUi:function(){activateSelect2(),activateAffix(),activateSidebarLayout(),activateZeroClipboard(),associateCopyBtn(),activateTooltip(),autofocus(),activateCarousel(),activateColorpicker()}}},uiController=uiControllerImpl();onLoadController.generals.push(uiController.activateUi);var uiDicerImpl=function(){function ajaxLaunchDice(topicId,param,description){return $.ajax({type:"POST",url:baseUrl+topicId,data:{param:param,description:description}})}function getNowDate(){var nowDate=new Date;return nowDate.getFullYear()+"-"+nowDate.getMonth()+"1-"+nowDate.getDate()+" "+nowDate.getHours()+":"+nowDate.getMinutes()+":"+nowDate.getSeconds()}function dicerLaunch(topicId){var param=$("#dicerParamQuick").val(),description=$("#dicerDescriptionQuick").val();return $("#waitingQuickLaunch").removeClass("hide"),ajaxLaunchDice(topicId,param,description).done(function(retour){retour=forumController.beautifyDice(retour),$("#resultatDicerQuick").html(retour);var text="Vous avez lancé "+param+" et obtenu : "+retour+"<br>Description : "+description;$("#quickDicerRow").before('<tr>    <td colspan="2"><div class="postDice">'+text+"</div></td>    <td>&nbsp;</td></tr>")}).fail(function(){$("#resultatDicerQuick").html("Une erreur s'est produite.")}).always(function(){$("#waitingQuickLaunch").addClass("hide")}),!1}function dicerModalLaunch(){var param=$("#dicerParam").val(),description=$("#dicerDescription").val();return $("#waitingLaunch").removeClass("hide"),ajaxLaunchDice(0,param,description).then(function(retour){retour=forumController.beautifyDice(retour),$("#resultatDicer").html(retour);var strDate=getNowDate();$("#resultatDicerTable tbody tr:first").before("<tr>    <td></td>    <td>"+strDate+"</td>    <td>"+description+"</td>    <td>"+retour+"</td></tr>")}).fail(function(){$("#resultatDicer").html("Une erreur s'est produite.")}).always(function(){$("#waitingLaunch").addClass("hide")}),!1}var baseUrl=BASE_PATH+"/campagne/dicer/"+CAMPAGNE_ID+"/";return{dicerModalLaunch:dicerModalLaunch,dicerLaunch:dicerLaunch}},uiDicer=uiDicerImpl(),uiCharacterModalControllerImpl=function(){function openModal(){$("#persoModal").modal("show")}function addButtonBar(){$("#persoModal .btn-bar").html("");var url=BASE_PATH+"/perso/view_all/"+CAMPAGNE_ID;$("#persoModal .btn-bar").append('<a id="SwitchFDP" href="'+url+'" class="btn iconeBtn sidebarBtn quickLink2 FDPToolBarBtn" title="Personnages" role="button"><span><i class="icon-user"></i></span></a>')}function onEditFdp(){$("#EditFDP").click(function(){"none"==$("#SaveFDP").css("display")?$("#SaveFDP").css("display","block"):$("#SaveFDP").css("display","none"),$("#zoneFichepopUp .editable").each(function(){"rgb(0, 136, 204)"==$(this).css("color")?$(this).css("color","").editable("toggleDisabled"):$(this).css("color","#0088cc").editable("toggleDisabled"),"none"==$(this).css("display")&&($(this).css("display",""),$(this).addClass("editable-empty")),$(this).hasClass("editable-empty")&&("none"==$("#SaveFDP").css("display")&&$(this).css("display","none"),$(this).css("color","#DD1144"))})})}function onSaveFdp(){$("#SaveFDP").click(function(){var fieldsValue="";$("#zoneFicheCustomPopUp").find('input[id$="hidden"]').each(function(){fieldsValue+=$(this)[0].outerHTML}),$.ajax({type:"POST",url:BASE_PATH+"/campagne/persoModal/save/popup/"+CAMPAGNE_ID,data:{fields:fieldsValue},success:function(){},error:function(){alert("Echec de sauvegarde de la fiche de personnage !")}})})}function showModal(){0===$(".ui-dialog-titlebar").has("#SwitchFDP").length&&(addButtonBar(),openModal())}return{prepareModal:function(){onEditFdp(),onSaveFdp()},onPersoBtnClick:function(){$("#myPerso").click(function(){showModal()})}}},uiCharacterModalController=uiCharacterModalControllerImpl();onLoadController.campagnes.push(uiCharacterModalController.prepareModal),onLoadController.campagnes.push(uiCharacterModalController.onPersoBtnClick);var persoModalService=function(){"use strict";var component={},baseUrl=BASE_PATH+"/perso/ajax/",getUrl=function(campagne,id){return baseUrl+campagne+"/"+id},getModal=function(){return $("#genPersoModal")},getModalContent=function(){return $("#genPersoModal .modal-body")},getModalName=function(){return $("#genPersoModal .modal-name")},getData=function(campagne,id){return $.ajax({type:"GET",url:getUrl(campagne,id)})};return component.openPerso=function(campagne,id){getModalName().html("Chargement en cours..."),getModalContent().html(""),getData(campagne,id).done(function(data){getModalContent().html(data.content),getModalName().html(data.name)}),getModal().modal("show")},component}(),themeService=function(){"use strict";var component={},updateSidebarColor=function(color){$(".categorie").css("background-color",color),$(".sidebar").css("background-color",color)},updateLinkColor=function(color){$("#theme-container a").css("color",color)},updateSidebarLinkColor=function(color){$(".sidebar a").css("color",color),$(".sidebar").css("color",color),$("a.sidebarBtn").css("color","black")},updateTextColor=function(color){$("#theme-container").css("color",color)},updateOdd=function(color){$(".table-striped tbody > tr:nth-child(2n+1) > td").css("background-color",color),$(".table-striped tbody > tr:nth-child(2n+1) > th").css("background-color",color)},updateEven=function(color){$(".table-striped tbody > tr:nth-child(2n) > td").css("background-color",color),$(".table-striped tbody > tr:nth-child(2n) > th").css("background-color",color)},updateDialogue=function(color){$(".container-fluid .dialogue").css("color",color)},updatePensee=function(color){$(".container-fluid .pensee").css("color",color)},updateRp1=function(color){$(".container-fluid .rp1").css("color",color)},updateRp2=function(color){$(".container-fluid .rp2").css("color",color)},updateQuote=function(color){$(".container-fluid blockquote p").css("color",color),$(".container-fluid blockquote").css("color",color)},updateHr=function(){var value=$("#hr").val();$("hr").css("background-image","url("+value+")")},updateBann=function(){var value=$("#bann").val();$(".logo_campagne").css("background-image","url("+value+")")},getTheme=function(id){return $.ajax({type:"GET",url:BASE_PATH+"/themes/"+id})};return component.refresh=function(){updateOdd($("#odd_line_color").val()),updateEven($("#even_line_color").val()),updateTextColor($("#text_color").val()),updateSidebarColor($("#sidebar_color").val()),updateLinkColor($("#link_color").val()),updateSidebarLinkColor($("#link_sidebar_color").val()),updateDialogue($("#dialogue_color").val()),updatePensee($("#pensee_color").val()),updateRp1($("#rp1_color").val()),updateRp2($("#rp2_color").val()),updateHr(),updateBann(),updateQuote($("#quote_color").val())},component.apply=function(){var id=$("#theme-choice").val();getTheme(id).done(function(data){$("#odd_line_color").val(data.odd_line_color),$("#even_line_color").val(data.even_line_color),$("#text_color").val(data.text_color),$("#sidebar_color").val(data.sidebar_color),$("#link_color").val(data.link_color),$("#link_sidebar_color").val(data.link_sidebar_color),$("#dialogue_color").val(data.dialogue_color),$("#pensee_color").val(data.pensee_color),$("#rp1_color").val(data.rp1_color),$("#rp2_color").val(data.rp2_color),$("#quote_color").val(data.quote_color),component.refresh()})},component}(),campagneConfig=function(tinyMCE){"use strict";var component={},baseUrl=BASE_PATH+"/campagne/",getUrl=function(campagne,type){return baseUrl+campagne+"/"+type},getUrlInscription=function(type,campagne,user){return baseUrl+type+"/"+campagne+"/"+user},save=function(type,campagne,data){return $.ajax({type:"POST",url:getUrl(campagne,type),data:data})},inscription=function(type,campagne,user){return $.ajax({type:"GET",url:getUrlInscription(type,campagne,user)})},setMsg=function(type,msg){$("#campagneMsg").html("<div class='alert alert-"+type+"'> "+msg+"</div>")};return component.saveDescription=function(campagne){tinyMCE.triggerSave();var data=$("#gameDescForm").serialize();return save("desc",campagne,data).done(function(){setMsg("success","Campagne sauvegardé")}).fail(function(err){setMsg("danger",err)}),!1},component.saveSheet=function(campagne){tinyMCE.triggerSave();var cloneDiv,fieldsValue="";cloneDiv=1==mode?$("#zoneFiche").clone():$("#zoneFicheCustom").clone(),cloneDiv.find(".editable-popup").each(function(){$(this).remove()}),cloneDiv.find('div[id^="JDRollUserControl_"]').each(function(){fieldsValue+=$(this)[0].outerHTML,$(this).remove()}),$("#hiddenInput").val(cloneDiv.html()),$("#hiddenInputFields").val(fieldsValue);var data=$("#gameSheetForm").serialize();return save("sheet",campagne,data).done(function(){setMsg("success","Feuille de personnage sauvegardé")}).fail(function(err){setMsg("danger",err)}),!1},component.saveTheme=function(campagne){var data=$("#gameThemeForm").serialize();return save("theme",campagne,data).done(function(){setMsg("success","Thème sauvegardé")}).fail(function(err){setMsg("danger",err)}),!1},component.saveDivers=function(campagne){tinyMCE.triggerSave();var data=$("#gameDiversForm").serialize();return save("divers",campagne,data).done(function(){setMsg("success","Campagne sauvegardé")}).fail(function(err){setMsg("danger",err)}),!1},component.deleteParticipant=function(campagne,user){return bootbox.confirm("Désinscrire ce joueur ?",function(confirmed){confirmed&&inscription("ban",campagne,user).done(function(){setMsg("success","Joueur désinscrit"),$("#inscription"+user).css("display","none"),$("div#inscription"+user).css("display","none")}).fail(function(err){setMsg("danger",err)})}),!1},component.addParticipant=function(campagne,user){return inscription("valid",campagne,user).done(function(){$("div#inscription"+user).css("display","none"),$("#inscription"+user+" button").css("display","none"),setMsg("success","Joueur accepté")}).fail(function(err){setMsg("danger",err)}),!1},component.deleteCarte=function(carte,domObject){return bootbox.confirm("Supprimer cette carte ?",function(confirmed){confirmed&&$.get("carte/delete/"+carte).done(function(){setMsg("success","Carte supprimée"),domObject.remove()}).fail(function(err){setMsg("danger",err)})}),!1},component}(tinyMCE),feedbackService=function(){var component={},baseUrl=BASE_PATH+"/feedback/",getUrlToPush=function(){return baseUrl},getUrlToUpdate=function(id){return baseUrl+id},getUrlToVote=function(id){return baseUrl+id+"/vote"},getModal=function(){return $("#feedbackPopup")},getTitle=function(){return $("#feedbackPopup #feedbackTitle").val()},getContent=function(){return $("#feedbackPopup #feedbackContent").val()},resetModal=function(){$("#feedbackPopup #feedbackTitle").val(""),tinyMCE.get("feedbackContent").setContent("")},setModalMsg=function(msg){$("#feedbackPopup .msg").html(msg)},setFeedbackMsg=function(msg){$("#feedbacksMsg").html(msg)},saveFeedback=function(){return tinyMCE.triggerSave(),$.ajax({type:"POST",url:getUrlToPush(),data:{title:getTitle(),content:getContent()}})},closeFeedback=function(id){return $.ajax({type:"DELETE",url:getUrlToUpdate(id)})},voteFeedback=function(id,score){return $.ajax({type:"POST",url:getUrlToVote(id),data:{score:score}})};return component.pushFeedback=function(){setModalMsg(""),saveFeedback().done(function(){resetModal(),setModalMsg('<div class="alert alert-success">Merci pour votre contribution !</div>')})},component.close=function(id){bootbox.confirm("Fermer ce feedback ?",function(confirmed){confirmed&&(setFeedbackMsg(""),closeFeedback(id).done(function(){setFeedbackMsg('<div class="alert alert-success">Feedback modifié avec succès</div>'),$("#feedback"+id).css("display","none")}))})},component.voteUp=function(id){setFeedbackMsg(""),voteFeedback(id,1).done(function(){setFeedbackMsg('<div class="alert alert-success">Vote enregistré avec succès</div>'),$("#feedbackVote"+id).css("display","none")}).fail(function(){setFeedbackMsg('<div class="alert alert-danger">Vote non enregistré</div>')})},component.voteDown=function(id){setFeedbackMsg(""),voteFeedback(id,-1).done(function(){setFeedbackMsg('<div class="alert alert-success">Vote enregistré avec succès</div>'),$("#feedbackVote"+id).css("display","none")}).fail(function(){setFeedbackMsg('<div class="alert alert-danger">Vote non enregistré</div>')})},component.openModal=function(){getModal().modal("show")},component}(),forumControllerImpl=function(){"use strict";function onForumLoaded(){var reg=/.*? a lancé .*? et a obtenu : (.*?)Description : .*/i;$(".postDice").each(function(index,post){var dice=reg.exec(post.innerHTML);null!==dice&&(post.innerHTML=post.innerHTML.replace(dice[1],beautifyDice(dice[1])))}),$("#resultatDicerTable td:last-child").each(function(index,line){line.innerHTML=beautifyDice(line.innerHTML)})}var beautifyDice=function(original){var newString=original.replace(/d([0-9fu]*)(.?) \( (.*?) \)/g,function($value,$1,$2,$3){var exploded=parseInt($1)<parseInt($3);return'<span class="dice dice_'+$1+" "+(exploded?"dice_exploded":"")+'">'+$3+"</span>"});return newString!=original?'<span class="diceLine">'+newString+"</span>":original};return{onForumLoaded:onForumLoaded,beautifyDice:beautifyDice}},forumController=forumControllerImpl();onLoadController.generals.push(forumController.onForumLoaded),$(function(){$(document).on("click",".collapserLink",function(e){e.preventDefault();var sign=$(this).children("i");sign.hasClass("icon-chevron-sign-down")?sign.removeClass("icon-chevron-sign-down").addClass("icon-chevron-sign-up"):sign.removeClass("icon-chevron-sign-up").addClass("icon-chevron-sign-down")})}),$(function(){$(document).on("click","a.btn-danger",function(e){e.stopPropagation(),e.preventDefault();var location=$(this).attr("href");bootbox.confirm("L'action demandé est une action dangereuse (Suppression, Quitter une partie, ...). Etes-vous sur ? ",function(confirmed){confirmed&&window.location.replace(location)})})});